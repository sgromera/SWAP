Jose Luis Rojano Ramírez
Sergio Romera Guzmán
                        Servidores Web de Altas Prestaciones

Infraestructura de Twitch

Qué es Twitch
    
Twitch es una plataforma de streaming de video en directo, enfocado en gran medida en la retransmisión de videojuegos, IRL (In Real Life) y cobertura de eventos de carácter mundial, como los eSports.

Fue creada en Junio de 2011 como un subproducto de Justin.tv, otro servicio de streaming. Twitch creció rápidamente, tanto fue así, que a mediados de 2013 conseguía un promedio de 43 millones de espectadores al mes, y para febrero de 2014 se consolidó como la cuarta mayor fuente de tráfico de internet en los EEUU. En agosto de ese mismo año Justin.tv cerró y en septiembre Amazon compró Twitch por 970.482.567$.
  
Qué ve el usuario. Análisis de funcionamiento

    El servicio de Twitch está hecho para ser fácil de consumir por el usuario, ofreciendo todo el contenido a través de su página web, además de contar con soporte para Android, iOS y la mayoría de consolas actuales. Cuando accedemos al servicio, encontramos una gran variedad de retransmisiones, priorizando generalmente aquellas más cercanas al usuario y con idioma local. Las retransmisiones se agruparán por categorías, donde predominan títulos específicos de videojuegos (cada videojuego cuenta como una categoría aparte). Sin embargo, podemos encontrar otro tipo de contenido como IRL, Podcasts, contenido musical o artístico e incluso ASMR.

    Las recomendaciones que Twitch nos muestra pueden no ser muy acertadas pero sí nos creamos una cuenta y acudimos a retransmisiones de nuestro interés, podremos seguir a nuestros creadores de contenido favoritos y hasta suscribirnos a su canal por un pequeño importe que se reparte entre el creador y Twitch. Esto, junto con la publicidad que Twitch permite colocar en las retransmisiones, son la fuente principal de beneficios tanto de Twitch como de todos los streamers.

    Al entrar en una retransmisión, podemos ver los 2 elementos de los cuales se compone cada directo: la retransmisión del creador y el chat, donde pueden intervenir los espectadores enviando mensajes de texto, emoticonos, etc. Todo esto es, a grosso modo, Twitch.

Qué sabemos de sus servidores

De la propia naturaleza de Twitch podemos sacar ciertas conclusiones:

Es un servicio que requiere poca latencia, ya que se busca la simultaneidad de los contenidos entre todos los espectadores, tanto para la retransmisión como para el chat
Al ser una plataforma global, deben existir servidores distribuidos por todo el globo para permitir que cualquier persona pueda retransmitir con fluidez

La información relativa a los servidores de Twitch es algo limitada y únicamente contamos con la poca información dada por la propia compañía y la interacción directa que tienen los usuarios con la misma.

Se sabe que actualmente Twitch tiene servidores repartidos por todo el mundo, en distintas regiones. Cuando un canal inicia un directo, empieza a transmitir hacia un servidor, a su elección, aunque por lo general es en aquel que se encuentre más cercano. Este sería el “nodo principal” y si todos los espectadores del directo tienen como nodo más cercano el principal, todos se conectarán a este para recibir la información. Si en algún momento se unen espectadores de otra región más lejana, con un nodo más cercano a ellos, Twitch realizará un “duplicado” del directo, llevando la transmisión a este nodo, reduciendo así los tiempos de latencia para aquellos usuarios.  

Respecto al chat, no hemos podido comprobar la concurrencia de mensajes, es decir, si para todos los usuarios los mensajes aparecen en el mismo orden. Tendría sentido que cada usuario tuviese un orden distinto, ya que dependiendo del lugar donde se encuentre unos mensajes pueden llegar antes que otros.

El servicio de Twitch permite el uso de herramientas de terceros como Open Broadcaster Software, OBS para abreviar, con el cual se facilita mucho la grabación y transmisión de vídeo al servidor principal de Twitch.

Para hacer streaming se necesita una clave o key, única para cada usuario, clave que se utiliza en la aplicación de grabación para transmitir directamente al servidor, sin necesidad de interactuar con la página. Existen dos opciones a la hora de transmitir a los espectadores: latencia normal o latencia baja. Se recomienda utilizar latencia baja para espectadores que están cerca de nosotros (nodos cercano) y nuestro streaming requiere interactividad. En otro caso, se recomienda latencia normal.

Hemos supuesto que, si se tiene latencia normal, los servidores que están transmitiendo el directo se sincronizan entre sí para garantizar que todos los espectadores están viendo el contenido simultáneamente. Por lo tanto, la opción de latencia baja trataría de enviar el contenido lo más rápido posible a cada espectador, sacrificando simultaneidad pero disminuyendo los tiempos de retardo.  


Implementación de sus tecnologías

El servicio de Twitch se divide en diversas partes interconectadas, cada una con una finalidad clara y que podemos dividir en:
Sistema de vídeo
Chat
Web APIs
Web y Clientes de la aplicación

    Nos vamos a basar en 2 de estas partes: el sistema de vídeo y el chat. Hay información, aunque bastante escasa, que hemos podido encontrar en el blog oficial de Twitch.

    Primero el sistema trata de recoger el contenido transmitido por el usuario que hace el directo. Esto se hace a través de RTMP o Real-Time Messaging Protocol, tecnología diseñada para la transmisión de vídeo, audio y datos en general que actualmente posee Adobe. El sistema recoge los datos y, utilizando C/C++ y Go, se transforman en flujos HLS (HTTP Live Streaming), un protocolo implementado por la compañía Apple Inc. basado en HTTP para el envío de datos como flujos con tasas de bits adaptables. Estos flujos se envían a todos los nodos que soliciten el contenido, para lo que se utiliza Go. Además, el contenido puede ser guardado como video para poder verlo después, esta es la parte VOD (Video On Demand) de la plataforma.

El chat, por su parte, es un sistema altamente distribuido escrito en Go. Utiliza el protocolo IRC (Internet Relay Chat) que permite la implementación de un chat en la que intervienen dos o más personas. Estas dos tecnologías juntas permiten un chat global y simultáneo entre todos los espectadores de un streaming.  

    
Bibliografía


Post reddit explicando como funciona el streaming en twitch
https://www.reddit.com/r/Twitch/comments/3ssk6g/how_twitch_server_work_exactly/

Servidores distribuidos 
https://boinx.com/connect/mimolive/knowledge/streaming/WS100412

Como hacer streaming desde linux
https://www.addictivetips.com/ubuntu-linux-tips/stream-to-twitch-command-line-linux/

Blog oficial de reddit explicando detalles de implementación
https://blog.twitch.tv/twitch-engineering-an-introduction-and-overview-a23917b71a25
